<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Gymnasium List</title>
  <script>
    // Get current location and pass it to a callback
    function getLocation(callback) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            callback(latitude, longitude);
          },
          showError
        );
      } else {
        document.getElementById("location").innerHTML = "Geolocation is not supported by this browser.";
      }
    }

    // API call: lat + long only
    function getNearestGymnasium(latitude, longitude) {
      fetch("http://127.0.0.1:5000/gymnasium", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          latitude: latitude,
          longitude: longitude
        })
      })
        .then(response => response.ok ? response.json() : response.text().then(Promise.reject))
        .then(renderGymnasiumData)
        .catch(error => console.error("Error:", error));
    }

    // API call: lat + long + radius
    function getGymnasiumWithInRadius(latitude, longitude) {
      const radius = document.getElementById("radius").value;
      if(radius <= 0 || radius > 1573) {
        document.getElementById("location").innerHTML = "Enter a valid radius value";
        return
      }
      const sortBy = document.getElementById("sortBy").value;
      const program = document.getElementById("program").value;
      const radios = document.getElementsByName('SortOrder');
      let selectedSortOrder = '';
      for (const radio of radios) {
        if (radio.checked) {
          selectedSortOrder = radio.value;
          break;
        }
      }
      const minMerit = document.getElementById("minMerit").value;
      const maxMerit = document.getElementById("maxMerit").value;
      fetch("http://127.0.0.1:5000/gymnasium-within-radius", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          latitude: latitude,
          longitude: longitude,
          radius: radius,
          sortBy: sortBy,
          sortOrder: selectedSortOrder,
          minMerit: minMerit,
          maxMerit: maxMerit,
          program: program
        })
      })
        .then(response => response.ok ? response.json() : response.text().then(Promise.reject))
        .then(renderGymnasiumData)
        .catch(error => console.error("Error:", error));
    }

    // Shared response rendering
    function renderGymnasiumData(data) {
      if (data && data.length == 0) {
        document.getElementById("GymnasiumListData").innerHTML = "No gymnasium found";
        return
      }
      console.log(data);
      let row = "";
      for (let i = 0; i < data.length; i++) {
        row += "<tr>" +
          "<td>" + data[i].Name + "</td>" +
          "<td>" + data[i].Year + "</td>" +
          "<td>" + data[i].Is_Preliminary + "</td>" +
          "<td>" + data[i].Kommun + "</td>" +
          "<td>" + data[i].Organisitionsform + "</td>" +
          "<td>" + data[i].Studievagskod + "</td>" +
          "<td>" + data[i].Studievag + "</td>" +
          "<td>" + data[i].Antagningsgrans + "</td>" +
          "<td>" + data[i].Median + "</td>" +
          "<td>" + data[i].Antal_platser + "</td>" +
          "<td>" + data[i].Antagna + "</td>" +
          "<td>" + data[i].Reserver + "</td>" +
          "<td>" + data[i].Lediga_platser + "</td>" +
          "</tr>";
      }
      document.getElementById("GymnasiumListData").innerHTML = row;
    }

    // Error handling
    function showError(error) {
      let message = "";
      switch (error.code) {
        case error.PERMISSION_DENIED:
          message = "User denied the request for Geolocation.";
          break;
        case error.POSITION_UNAVAILABLE:
          message = "Location information is unavailable.";
          break;
        case error.TIMEOUT:
          message = "The request to get user location timed out.";
          break;
        case error.UNKNOWN_ERROR:
          message = "An unknown error occurred.";
          break;
      }
      document.getElementById("location").innerHTML = message;
    }
  </script>
</head>

<body>

<button onclick="getLocation(getNearestGymnasium)" type="button">Get Gymnasiums Near Me (top ten)</button>

 <br/>
 <br/>
 <br/>
 <br/>

<label for="sortBy">Sort by:</label>
<select name="sortBy" id="sortBy">
  <option value="skola" selected>Name</option>
  <option value="antagningsgräns">Antagningsgräns</option>
  <option value="median">Median</option>
  <option value="studieväg">Studieväg</option>
</select>

     <input type="radio" id="asc" name="SortOrder" value="asc" checked>
     <label for="asc">Ascending</label>
     <input type="radio" id="desc" name="SortOrder" value="desc">
     <label for="desc">Descending</label>
 <br/>

<label for="program">Select:</label>
<select name="program" id="program" multiple>
    <option value="natur" selected>Natur</option>
    <option value="sam">Samhäll</option>
    <option value="ek">Ekonomi</option>
    <option value="estet">Estet</option>
    <option value="teknik">Teknik</option>
    <option value="el">El och energi</option>
    <option value="naturbruk">Naturbruk</option>
    <option value="barn och">Barn och fritid</option>
    <option value="försäljnings och">Försäljnings och Service</option>
    <option value="fordon">Fordon och transport</option>
    <option value="frisör">Frisör och stylist</option>
    <option value="hu">Humanistiska</option>
    <option value="bygg">Bygg och anläggning</option>
    <option value="vård">Vård och omsorg</option>
    <option value="res">Resturaung och livsmedel</option>
    <option value="international">International Baccalaureate</option>
    <option value="vvs och fastighet">VVS och fastighet</option>
    <option value="hotell">Hotell och turism</option>
    <option value="introduktion">Introduktion</option>
    <option value="industritekniska">Industritekniska</option>
    <option value="sjöfart">Sjöfart</option>
    <option value="marinteknik">Marinteknik</option>
    <option value="yrkesdans">Yrkesdans</option>
    <option value="flygteknik">Flygteknik</option>

</select>

 <br/>
<label>Minimum merit:</label>
<input type="number" id="minMerit" name="minMerit" value=0 min = 0 max = 335>
<label>Maximum merit:</label>
<input type="number" id="maxMerit" name="maxMerit" value=340 min = 0 max = 340>
<br/>
<br/>
  <label>Enter the radius: </label><input type="number" id="radius">
  <button onclick="getLocation(getGymnasiumWithInRadius)" type="button">Get Gymnasiums within radius (km)</button>



<p id="location"></p>

  <table id="GymnasiumList">
    <tr>
      <th>Name</th>
      <th>Year</th>
      <th>Is_Preliminary</th>
      <th>Kommun</th>
      <th>Organisitionsform</th>
      <th>Studievägskod</th>
      <th>Studieväg</th>
      <th>Antagningsgräns</th>
      <th>Median</th>
      <th>Antal_platser</th>
      <th>Antagna</th>
      <th>Reserver</th>
      <th>Lediga_platser</th>
    </tr>
    <tbody id="GymnasiumListData">
    </tbody>

  </table>
</body>

</html>